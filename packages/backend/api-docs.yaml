openapi: 3.1.0
info:
  title: Tienda Sol API
  version: 1.0.0
  description: API REST de Tienda Sol.
servers:
  - url: http://localhost:3000/
tags:
  - name: health
  - name: usuarios
  - name: productos
  - name: pedidos
  - name: notificaciones
  - name: credenciales
  - name: docs

paths:
  /docs:
    get:
      tags:
        - docs
      operationId: verDocumentacion
      summary: Documentación interactiva (Swagger UI)
      description: Devuelve la interfaz HTML de documentación de la API.
      security: []
      responses:
        '200':
          description: HTML de Swagger UI
          content:
            text/html:
              schema:
                type: string

  /health:
    get:
      tags:
        - health
      operationId: health
      security: []
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string

  /usuarios:
    post:
      tags:
        - usuarios
      operationId: crearUsuario
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UsuarioCreate' }
      responses:
        '201':
          description: Creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Usuario' }
        '400': { $ref: '#/components/responses/Error400' }
        '409': { $ref: '#/components/responses/Error409' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }
    get:
      tags:
        - usuarios
      operationId: listarVendedores
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Usuario'
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /usuarios/{id}/pedidos:
    get:
      tags:
        - pedidos
      operationId: historialPedidosUsuario
      parameters:
        - $ref: '#/components/parameters/IdPath'
      security:
        - userIdAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PedidoList' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '404': { $ref: '#/components/responses/Error404' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /usuarios/{id}/notificaciones:
    get:
      tags:
        - notificaciones
      operationId: listarNotificaciones
      parameters:
        - $ref: '#/components/parameters/IdPath'
        - name: tipo
          in: query
          schema:
            type: string
            enum: [leidas, no_leidas, todas]
            default: todas
      security:
        - userIdAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NotificacionList' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '404': { $ref: '#/components/responses/Error404' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /productos:
    post:
      tags:
        - productos
      operationId: crearProducto
      security:
        - userIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProductoCreate' }
      responses:
        '201':
          description: Creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Producto' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '409': { $ref: '#/components/responses/Error409' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }
    get:
      tags:
        - productos
      operationId: listarProductos
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - name: orderBy
          in: query
          schema: { type: string, enum: [precio, cantidadesVendidas], default: cantidadesVendidas }
        - name: order
          in: query
          schema: { type: string, enum: [asc, desc], default: desc }
        - name: busqueda
          in: query
          schema: { type: string }
        - name: vendedor
          in: query
          schema: { type: string }
        - name: minPrice
          in: query
          schema:
            type: integer
            minimum: 0
        - name: maxPrice
          in: query
          schema:
            type: integer
            minimum: 0
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProductoList' }
        '400': { $ref: '#/components/responses/Error400' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /pedidos:
    post:
      tags:
        - pedidos
      operationId: crearPedido
      security:
        - userIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PedidoCreate' }
      responses:
        '201':
          description: Creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Pedido' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '404': { $ref: '#/components/responses/Error404' }
        '409': { $ref: '#/components/responses/Error409' }
        '422': { $ref: '#/components/responses/Error422' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /pedidos/{id}:
    get:
      tags:
        - pedidos
      operationId: consultarPedido
      parameters:
        - $ref: '#/components/parameters/IdPath'
      security:
        - userIdAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Pedido' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '404': { $ref: '#/components/responses/Error404' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }
    patch:
      tags:
        - pedidos
      operationId: cambiarEstadoPedido
      parameters:
        - $ref: '#/components/parameters/IdPath'
      security:
        - userIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CambioEstado' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Pedido' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '404': { $ref: '#/components/responses/Error404' }
        '409': { $ref: '#/components/responses/Error409' }
        '422': { $ref: '#/components/responses/Error422' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /notificaciones/{id}:
    patch:
      tags:
        - notificaciones
      operationId: marcarNotificacionLeida
      parameters:
        - $ref: '#/components/parameters/IdPath'
      security:
        - userIdAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Notificacion' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '403': { $ref: '#/components/responses/Error403' }
        '404': { $ref: '#/components/responses/Error404' }
        '409': { $ref: '#/components/responses/Error409' }
        '500': { $ref: '#/components/responses/Error500' }
        '503': { $ref: '#/components/responses/Error503' }

  /login:
    post:
      tags:
        - credenciales
      operationId: login
      summary: Validar credenciales de usuario
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      security: []
      responses:
        '200':
          description: Usuario autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UsuarioAuth' }
        '400': { $ref: '#/components/responses/Error400' }
        '401': { $ref: '#/components/responses/Error401' }
        '500': { $ref: '#/components/responses/Error500' }

  /signin:
    post:
      tags:
        - credenciales
      operationId: signin
      summary: Registrar credenciales para un usuario existente
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      security: []
      responses:
        '201':
          description: Credencial creada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Credencial' }
        '400': { $ref: '#/components/responses/Error400' }
        '409': { $ref: '#/components/responses/Error409' }
        '500': { $ref: '#/components/responses/Error500' }

components:
  securitySchemes:
    userIdAuth:
      type: apiKey
      in: header
      name: Authorization
      description: "Header API key o token de autorización. Valor esperado por el middleware 'autentificar' (por ejemplo: \"Bearer <token>\" o el id del usuario según implementación)."

  parameters:
    IdPath:
      name: id
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Id'
    Page:
      name: page
      in: query
      schema: { type: integer, minimum: 1, default: 1 }
    Limit:
      name: limit
      in: query
      schema: { type: integer, minimum: 1, maximum: 100, default: 9 }

  responses:
    Error400:
      description: Error de validación (input inválido)
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error401:
      description: No autenticado
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error403:
      description: Prohibido (no autorizado)
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error404:
      description: No encontrado
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error409:
      description: Conflicto (p.ej. recursos duplicados o acciones no permitidas)
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error422:
      description: Error de dominio / reglas de negocio
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error500:
      description: Error interno del servidor
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
    Error503:
      description: Servicio no disponible (problema con la base de datos)
      content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  schemas:
    Id:
      type: string
      pattern: '^[a-fA-F0-9]{24}$'

    UsuarioCreate:
      type: object
      required: [nombre, email, tipo]
      properties:
        nombre: { type: string, minLength: 1 }
        email: { type: string, format: email }
        telefono:
          type: string
          pattern: '^\\+?\\d{7,15}$'
        tipo: { type: string, enum: [ADMIN, COMPRADOR, VENDEDOR] }
    Usuario:
      type: object
      required: [id, nombre, email, tipo]
      properties:
        id: { $ref: '#/components/schemas/Id' }
        nombre: { type: string }
        email: { type: string, format: email }
        telefono:
          type: string
          nullable: true
          pattern: '^\\+?\\d{7,15}$'
        tipo: { type: string, enum: [ADMIN, COMPRADOR, VENDEDOR] }
        fechaAlta: { type: string, format: date-time, nullable: true }

    Moneda:
      type: string
      enum: [PESO_ARG, DOLAR_USA, REAL]
    ProductoCreate:
      type: object
      required: [titulo, descripcion, categorias, precio, moneda, stock, fotos, activo]
      properties:
        titulo: { type: string, minLength: 1 }
        descripcion: { type: string, minLength: 1 }
        categorias:
          type: array
          minItems: 1
          items: { type: string, minLength: 1 }
        precio: { type: number, minimum: 0 }
        moneda: { $ref: '#/components/schemas/Moneda' }
        stock: { type: integer, minimum: 0 }
        fotos:
          type: array
          minItems: 1
          items: { type: string, format: uri }
        activo: { type: boolean }
    Producto:
      type: object
      required: [id, titulo, descripcion, categorias, precio, moneda, stock, fotos, activo, vendedorId]
      properties:
        id: { $ref: '#/components/schemas/Id' }
        titulo: { type: string }
        descripcion: { type: string }
        categorias:
          type: array
          items: { type: string }
        precio: { type: number }
        moneda: { $ref: '#/components/schemas/Moneda' }
        stock: { type: integer }
        fotos:
          type: array
          items: { type: string, format: uri }
        activo: { type: boolean }
        vendedorId: { $ref: '#/components/schemas/Id' }
        vendidos: { type: integer, nullable: true }
        fechaAlta: { type: string, format: date-time, nullable: true }
        fechaActualizacion: { type: string, format: date-time, nullable: true }
    ProductoList:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Producto' }
        paginacion:
          $ref: '#/components/schemas/PaginacionProductos'
    PaginacionProductos:
      type: object
      properties:
        page: { type: integer }
        limit: { type: integer }
        total: { type: integer }
        totalPages: { type: integer }
        orderBy: { type: string, enum: [precio, cantidadesVendidas] }
        order: { type: string, enum: [asc, desc] }

    EstadoPedido:
      type: string
      enum: [cancelado, entregado, enviado, enPreparacion, confirmado, pendiente]
    ItemPedidoCreate:
      type: object
      required: [productoID, cantidad]
      properties:
        productoID: { $ref: '#/components/schemas/Id' }
        cantidad: { type: integer, minimum: 1 }
    ItemPedido:
      type: object
      required: [productoID, cantidad, precioUnitario, subtotal]
      properties:
        productoID: { $ref: '#/components/schemas/Id' }
        cantidad: { type: integer }
        precioUnitario: { type: number }
        subtotal: { type: number }
    DireccionEntrega:
      type: object
      required: [calle, altura, codigoPostal, ciudad, provincia, pais]
      properties:
        calle: { type: string }
        altura: { type: integer }
        piso: { type: string, nullable: true }
        departamento: { type: string, nullable: true }
        codigoPostal: { type: string }
        ciudad: { type: string }
        provincia: { type: string }
        pais: { type: string }
        lat: { type: number, nullable: true }
        lon: { type: number, nullable: true }
    PedidoCreate:
      type: object
      required: [items, moneda, direccionEntrega]
      properties:
        items:
          type: array
          minItems: 1
          items: { $ref: '#/components/schemas/ItemPedidoCreate' }
        moneda: { $ref: '#/components/schemas/Moneda' }
        direccionEntrega: { $ref: '#/components/schemas/DireccionEntrega' }
    CambioEstado:
      type: object
      required: [nuevoEstado, motivo]
      properties:
        nuevoEstado: { $ref: '#/components/schemas/EstadoPedido' }
        motivo: { type: string, minLength: 1 }
    Pedido:
      type: object
      required: [id, compradorId, vendedorId, estado, items, total, moneda, direccionEntrega]
      properties:
        id: { $ref: '#/components/schemas/Id' }
        compradorId: { $ref: '#/components/schemas/Id' }
        vendedorId: { $ref: '#/components/schemas/Id' }
        estado: { $ref: '#/components/schemas/EstadoPedido' }
        items:
          type: array
          items: { $ref: '#/components/schemas/ItemPedido' }
        moneda: { $ref: '#/components/schemas/Moneda' }
        direccionEntrega: { $ref: '#/components/schemas/DireccionEntrega' }
        historialEstados:
          type: array
          items:
            type: object
            properties:
              estado: { $ref: '#/components/schemas/EstadoPedido' }
              fecha: { type: string, format: date-time }
              motivo: { type: string, nullable: true }
        total: { type: number }
        fechaCreacion: { type: string, format: date-time, nullable: true }
        fechaActualizacion: { type: string, format: date-time, nullable: true }
        fechaCancelacion: { type: string, format: date-time, nullable: true }
        fechaEnvio: { type: string, format: date-time, nullable: true }
        fechaEntrega: { type: string, format: date-time, nullable: true }
    PedidoList:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Pedido' }
        paginacion:
          $ref: '#/components/schemas/PaginacionGenerica'
    PaginacionGenerica:
      type: object
      properties:
        page: { type: integer }
        limit: { type: integer }
        total: { type: integer }
        totalPages: { type: integer }

    Notificacion:
      type: object
      required: [id, usuarioDestinoId, mensaje, leida, fechaAlta]
      properties:
        id: { $ref: '#/components/schemas/Id' }
        usuarioDestinoId: { $ref: '#/components/schemas/Id' }
        mensaje: { type: string }
        detalles:
          type: object
          additionalProperties: true
          nullable: true
        leida: { type: boolean }
        fechaAlta: { type: string, format: date-time }
        fechaLeida: { type: string, format: date-time, nullable: true }
    NotificacionList:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Notificacion' }
        paginacion:
          $ref: '#/components/schemas/PaginacionGenerica'

    Error:
      type: object
      properties:
        name:
          type: string
          description: "Nombre de la clase de error (p.ej. ObjetoNoEncontradoError, DuplicadoError)"
        status:
          type: integer
          description: "Código HTTP asociado al error"
        error:
          type: string
          description: "Mensaje legible del error"
        detalles:
          type: object
          description: "Objeto con detalles específicos del error (estructura variable según el tipo de error)"
          additionalProperties: true
          nullable: true

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string }
        password: { type: string }

    RegisterRequest:
      type: object
      required: [username, password, usuarioId]
      properties:
        username: { type: string }
        password: { type: string, minLength: 6 }
        usuarioId: { $ref: '#/components/schemas/Id' }

    Credencial:
      type: object
      required: [id, username, usuarioId]
      properties:
        id: { $ref: '#/components/schemas/Id' }
        username: { type: string }
        usuarioId: { $ref: '#/components/schemas/Id' }

    UsuarioAuth:
      type: object
      required: [id, tipo]
      properties:
        id: { $ref: '#/components/schemas/Id' }
        tipo: { type: string }

